---
- name: Apache Setup - Install Apache
  apt: name=apache2 state=latest
  notify:
    - restart apache
  tags:
    - apache-setup

- name: Apache Setup - Install mod wsgi
  apt: name=libapache2-mod-wsgi state=latest
  notify:
    - restart apache
  tags:
    - mod_wsgi
    - apache-setup

- name: Apache Setup - Enable sslmod
  command: a2enmod ssl
  sudo: yes
  notify:
    - restart apache
  tags:
    - ssl_mod
    - apache-setup

- name: Apache Setup - push fdqn file
  copy: content='ServerName {{ inventory_hostname }}' dest='{{ apache_fqdn_path }}'
  ignore_errors: True
  register: push_fdqn_file
  tags:
    - configure-apache-fdqn

- name: Apache Setup - push fdqn file on Ubuntu 13.04+
  copy: content='ServerName {{ inventory_hostname }}' dest='{{ apache_conf_path }}fdqn.conf'
  when: push_fdqn_file|failed
  tags:
    - configure-apache-fdqn

- name: Apache Setup - enable mod_rewrite
  command: a2enmod rewrite
  sudo: yes
  notify:
    - restart apache
  tags:
    - mod_rewrite
    - apache-setup

- name: Apache Setup - add apache user to vagrant group
  user: name={{apache_user}} groups="vagrant,dialout"
  when: "'local' in inventory_hostname"
  ignore_errors: True
  tags:
    - apache-setup

- name: Apache Setup - disable weak SSLv2/3
  lineinfile: dest=/etc/apache2/mods-available/ssl.conf state=present backup=yes regexp="SSLProtocol all" line="SSLProtocol all -SSLv2 -SSLv3"
  notify:
    - restart apache
  tags:
    - apache-setup
    - test
