provider "{{ aws_terraform_provider }}" { }

resource "aws_vpc" "main_vpc" {
   cidr_block = "{{ aws_terraform_cidr_block }}"
}

resource "aws_security_group" "sec_group" {
   name = "sec_group"
   description = "Restricted security group"

   ingress {
      from_port = "{{ aws_terraform_elb_ssl_port }}"
      to_port = "{{ aws_terraform_elb_ssl_port }}"
      protocol = "{{ aws_terraform_tcp_protocol }}"
      cidr_blocks = ["{{ aws_terraform_cidr_block_28 }}","{{ aws_terraform_cidr_block_29 }}","{{ aws_terraform_cidr_block_30 }}","{{ aws_terraform_cidr_block_31 }}","{{ aws_terraform_cidr_block_32 }}"]
   }

   ingress {
      from_port = "{{ aws_terraform_ssh_port }}"
      to_port = "{{ aws_terraform_ssh_port }}"
      protocol = "{{ aws_terraform_tcp_protocol }}"
      cidr_blocks = ["{{ aws_terraform_default_cidr }}"]
   }

  egress {
      from_port = "{{ aws_terraform_default_from_port }}"
      to_port = "{{ aws_terraform_default_to_port }}"
      protocol = "{{ aws_terraform_default_protocol }}"
      cidr_blocks = ["{{ aws_terraform_default_cidr }}"]
  }
}

resource "aws_instance" "dev" {
  ami           = "{{ aws_terraform_region_ami }}"
  key_name      = "{{ aws_terraform_key_name }}"
  instance_type = "{{ aws_terraform_instance_type }}"
  vpc_security_group_ids = ["${aws_security_group.sec_group.id}"]

  count = {{ aws_terraform_instance_count }}

    tags {
        Name = "{{ aws_terraform_tag }}.${count-index}"
    }

    root_block_device {
        volume_type = "{{ aws_terraform_volume_type }}"
        volume_size = {{ aws_terraform_block_device_size }}
        delete_on_termination = true
    }
}
